# Принятые решения

Список решений, которые не были явно описаны в задании.

## 1. Конфликт user_id при добавлении в разные команды

При создании команды если user_id уже существует, пользователь обновляется и переносится в новую команду. Обновляются team_name, username и is_active. Это позволяет переводить пользователей между командами при создании новой команды.

## 2. Добавление новых участников в существующую команду

POST /team/add возвращает ошибку 400 TEAM_EXISTS если команда уже существует. Для добавления новых участников нужно создать команду заново с полным списком участников, включая старых и новых. Существующие пользователи обновятся, новые создадутся.

## 3. Алгоритм выбора ревьюверов

При создании PR из команды автора выбираются случайные активные участники. Исключается сам автор и пользователи с is_active = false. Если подходящих кандидатов 2 или больше, выбираются случайные 2. Если 1, назначается 1. Если 0, PR создается без ревьюверов. Для генерации случайных чисел используется crypto/rand.

## 4. Алгоритм переназначения ревьювера

При переназначении из команды заменяемого ревьювера выбирается случайный активный участник. Исключается автор PR, все текущие ревьюверы PR и пользователи с is_active = false. Если подходящих кандидатов нет, возвращается ошибка NO_CANDIDATE. Используется crypto/rand для случайного выбора.

## 5. Идемпотентность операции merge

При вызове POST /pullRequest/merge если PR уже в статусе MERGED, возвращается 200 OK с текущим состоянием PR. Поле merged_at устанавливается только при первом переходе в статус MERGED и больше не меняется. Повторные вызовы не приводят к ошибке и не изменяют данные.

## 6. Переназначение ревьювера при смене команды

В условии написано, что при переназначении ревьювера выбирается тиммейт из команды заменяемого ревьювера. Но заменяемый ревьюер мог сменить команду с момента назначения на PR. Я сделал так: при переназначении выбирается тиммейт из текущей команды заменяемого ревьювера, а не из той команды, в которой он был при первоначальном назначении. В жизни это нелогично, ведь программист мог уйти совсем в другой отдел, не тот, к которому относится PR, но чтобы не слишком додумывать и усложнять задание я оставил ровно описанную логику.

Цитата: "Переназначить конкретного ревьювера на другого из его команды"

## 7. Возврат всех PR в getReview

В спецификации для GET /users/getReview не указано, что нужно возвращать только открытые PR. Логичнее было бы возвращать только OPEN PR, так как для MERGED PR ревьювер уже не нужен. С другой стороны для знания истории проведенных человеком ревью почему нет. Так или иначе в спецификации не сказано фильтровать по статусу PR, поэтому я этого и не делал.

## 8. Массовая деактивация команды

При деактивации всей команды PR всегда остаётся привязан к текущей команде автора. Алгоритм:
1. Деактивируем всех пользователей команды (чтобы они не выдавались как активные кандидаты)
2. Для каждого открытого PR, где есть ревьюверы из деактивированной команды: удаляем этого ревьювера и пытаемся найти замену в текущей команде автора (это защищает от ситуаций когда юзер или автор сменили команду)
3. Если в команде автора нет активных кандидатов - PR остаётся с меньшим числом ревьюверов (или без них)